S√≠ ‚Äî **toca exactamente ahora** üëç
Este cap√≠tulo es el que evita muchos errores de modelado en producci√≥n. Vamos a hacerlo **pr√°ctico**, no acad√©mico.

---

# üìò Cap√≠tulo 8 ‚Äî **Unidades vs Euros**

**Poisson vs Gamma / Lognormal**

> **Pregunta central**:
> *¬øQu√© distribuci√≥n uso para repartir contribuciones cuando el total observado son unidades vs euros?*

---

## 1Ô∏è‚É£ Diferencia conceptual clave (la m√°s importante)

### üü¶ **Unidades**

Ejemplos:

* n¬∫ de prescripciones
* n¬∫ de ventas
* n¬∫ de conversiones
* n¬∫ de tickets

üëâ Son:

* discretas
* no negativas
* con varianza ‚âà media (o mayor)

üìå **Modelo natural**: **Poisson** (o NegBin)

---

### üüß **Euros**

Ejemplos:

* revenue
* margin
* GMV
* contribuci√≥n monetaria del MMM

üëâ Son:

* continuas
* positivas
* heavy-tailed
* con outliers estructurales

üìå **Modelo natural**: **Gamma** o **Lognormal**

---

## 2Ô∏è‚É£ Qu√© cambia *realmente* entre Poisson y Gamma

| Aspecto             | Poisson (unidades) | Gamma / Lognormal (euros) |
| ------------------- | ------------------ | ------------------------- |
| Tipo de variable    | Discreta           | Continua                  |
| Soporte             | {0,1,2,‚Ä¶}          | (0, +‚àû)                   |
| Varianza            | ‚âà media            | >> media                  |
| Outliers            | Poco frecuentes    | Comunes                   |
| Interpretaci√≥n      | Conteos            | Valor monetario           |
| Robustez            | Alta               | Media / baja              |
| Estabilidad EM      | Muy alta           | M√°s delicada              |
| Sensible a escalado | No                 | S√≠                        |

---

## 3Ô∏è‚É£ Impacto directo en el EM

### üîπ E-step (reparto)

**Importante**:
üëâ **El E-step es casi id√©ntico** en los tres casos.

En la pr√°ctica:

[
\hat z_{h,b}
============

y_b
\cdot
\frac{\lambda_h \omega_{b,h}}
{\sum_{h'} \lambda_{h'} \omega_{b,h'}}
]

* Poisson ‚Üí exacto
* Gamma ‚Üí exacto si shape com√∫n
* Lognormal ‚Üí aproximado (pero funciona)

üìå **El reparto (shares)** cambia poco entre modelos.

---

### üîπ M-step (aprendizaje de (\lambda))

Aqu√≠ s√≠ hay diferencias fuertes.

---

## 4Ô∏è‚É£ Poisson (unidades): el caso ‚Äúfeliz‚Äù

### Modelo

[
z_{h,b} \sim \text{Poisson}(\lambda_h \omega_{b,h})
]

### M-step cerrado (sin covariables)

[
\boxed{
\lambda_h
=========

\frac{\sum_b \hat z_{h,b}}{\sum_b \omega_{b,h}}
}
]

### Ventajas

* ultra-estable
* convexidad
* convergencia r√°pida
* f√°cil de explicar

### Riesgos

* si hay overdispersion fuerte ‚Üí subestima varianza

üìå **Default recomendado siempre que puedas.**

---

## 5Ô∏è‚É£ Gamma (euros): el caso realista

### Modelo

[
z_{h,b} \sim \text{Gamma}(k,\ \theta_h \omega_{b,h})
]
(media = (k\theta_h \omega))

### M-step

* (\theta_h): GLM Gamma (log link)
* (k): fijo o estimado global

### Ventajas

* respeta continuidad
* maneja colas largas
* interpretable en media

### Riesgos

* sensible a outliers extremos
* EM m√°s lento
* puede volverse inestable sin regularizaci√≥n

üìå Requiere:

* winsorizaci√≥n o trimming
* regularizaci√≥n
* buen escalado de (\omega)

---

## 6Ô∏è‚É£ Lognormal (euros): el caso peligroso

### Modelo

[
\log z_{h,b} \sim \mathcal N(\mu_h + \log \omega_{b,h},\ \sigma^2)
]

### Ventajas

* modela muy bien heavy tails
* muy com√∫n en revenue real

### Problemas serios en EM

* el reparto depende de (\exp(\mu))
* un outlier puede:

  * dominar el M-step
  * ‚Äúsecuestrar‚Äù (\lambda)
* no hay M-step cerrado

üìå **Solo recomendable si**:

* haces inferencia bayesiana
* o usas strong priors + VI

---

## 7Ô∏è‚É£ Sesgo por outliers (ejemplo mental)

Sup√≥n:

* 100 bricks normales
* 1 brick con revenue 100√ó mayor

### Poisson

* ese brick pesa 100√ó
* pero no rompe el modelo

### Gamma

* ese brick domina el likelihood
* (\lambda) se ajusta para ‚Äúexplicarlo‚Äù

### Lognormal

* el log ayuda, pero:
* el EM puede volverse err√°tico

üëâ **Esto no es un bug, es matem√°tica.**

---

## 8Ô∏è‚É£ Cu√°ndo conviene cada uno (gu√≠a pr√°ctica)

### ‚úÖ Usa **Poisson** si:

* trabajas con unidades
* puedes redefinir euros como:

  * n¬∫ de transacciones √ó ticket medio
* quieres estabilidad y explicabilidad

> **Recomendaci√≥n fuerte**:
> incluso para revenue, intenta modelar **unidades primero**.

---

### ‚úÖ Usa **Gamma** si:

* el negocio exige euros
* los outliers est√°n controlados
* tienes buena se√±al en (\omega)
* aplicas regularizaci√≥n

---

### ‚ö†Ô∏è Usa **Lognormal** solo si:

* tienes colas extremas reales
* est√°s c√≥modo con Bayesian inference
* aceptas m√°s complejidad

---

## 9Ô∏è‚É£ Regla de oro (muy importante)

> **El EM reparte masa.
> Cuanto m√°s ‚Äúpesada‚Äù sea la cola del total observado,
> m√°s cuidado necesitas en el M-step.**

---

## 10Ô∏è‚É£ Recomendaci√≥n final (industrial)

En la pr√°ctica, equipos maduros hacen:

1. **Modelar unidades con Poisson EM**
2. Convertir a euros *post hoc*:
   [
   \hat z^{‚Ç¨}*{h,b} = \hat z^{units}*{h,b} \times \text{ticket medio}
   ]
3. Usar Gamma solo si el paso 2 no es aceptable

---

## ‚úîÔ∏è Salida ‚Äî **Gu√≠a de model choice**

| Caso                     | Recomendaci√≥n            |
| ------------------------ | ------------------------ |
| Unidades                 | **Poisson (default)**    |
| Euros ‚Äúlimpios‚Äù          | Gamma                    |
| Euros con colas extremas | Lognormal (con cautela)  |
| Dudas                    | Poisson + conversi√≥n     |
| Producci√≥n cr√≠tica       | Poisson + regularizaci√≥n |

---

## Checkpoint

¬øTe encaja esta gu√≠a con lo que has visto en datos reales?

El siguiente cap√≠tulo natural ser√≠a:

* **Cap√≠tulo 9 ‚Äî Regularizaci√≥n, pooling y priors (c√≥mo evitar que EM se rompa)**
  o, si prefieres,
* **Cap√≠tulo 9 ‚Äî C√≥mo explicar todo esto a negocio sin ecuaciones**
