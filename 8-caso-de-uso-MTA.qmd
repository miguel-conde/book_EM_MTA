
# Caso de uso (MMM→MTA): repartir contribución a campañas/creatividades

## Introducción

En este capítulo se aplica el mismo patrón *agregado → desagregado* a un caso de uso habitual en medición de marketing: partir de un MMM (granularidad temporal semanal/diaria y, opcionalmente, por *geo*) y repartir la contribución de cada medio a niveles inferiores (campañas, creatividades u otras entidades). El objetivo es obtener un reparto consistente con **conservación de masa**: la suma de las contribuciones desagregadas debe coincidir exactamente con el total observado que produce el MMM.

El capítulo también fija dos ideas prácticas que guían el modelado: (i) cuando el MMM es incremental, el total que se reparte conserva esa interpretación, pero el reparto intra-canal no se vuelve causal por sí mismo; (ii) si el MMM usa transformaciones (adstock y saturación), la forma más coherente de llevarlo a EM es definir la exposición del reparto a partir de una **exposición efectiva** MMM-consistente.

Para una discusión operativa sobre software y por qué la capa EM intra-canal suele implementarse como componente *custom*, véase [Ap-1 — Software para MMM → MTA](91-ap-1-sw-para-MTA.qmd). Para nomenclatura e interpretación de exposición/offset (incluida *effective exposure*), véase [Ap-3 — Exposición y offset: nomenclatura e interpretación](93-ap-3-exposure.qmd).

Para una versión ejecutiva (EN) del encuadre MMM↔MTA y un bloque de Q&A defensivo, véase el [Ap-2 — Whitepaper para CXOs (EN)](92-ap-2-doc-CXOs.qmd).

## Planteamiento: observado, latente y conservación de masa

Para cada periodo (y opcionalmente geo) se dispone de:

* $t \in \{1,\dots,T\}$ (semana/día)
* $g \in \{1,\dots,G\}$ (geo) opcional

Del MMM se obtienen contribuciones por canal/medio:

* $C_{m,t}$ o $C_{m,t,g}$: contribución del **medio/canal** $m$ en ese corte.

Esta cantidad puede corresponder a *incremental contribution* o a contribución atribuida según el modelo; para EM se toma como un **total observado a repartir**.

El objetivo es repartir cada contribución de medio hacia unidades inferiores (campañas, creatividades, adsets, publishers, etc.). Se introduce entonces una variable latente:

* $z_{m,k,t}$ (o $z_{m,k,t,g}$): contribución del medio $m$ en $t$ asignada a campaña/creatividad $k$.

La restricción estructural (conservación de masa) es:
$$
\sum_{k\in \mathcal{K}_m} z_{m,k,t} = C_{m,t}
\quad (\text{o } \sum_k z_{m,k,t,g}=C_{m,t,g}).
$$

## Modelo generativo base (análogamente al HCP–Brick)

La analogía es directa:

| HCP–Brick            | MMM→MTA                                                   |
| -------------------- | --------------------------------------------------------- |
| Brick                | medio $m$, tiempo $t$, geo $g$                             |
| HCP                  | campaña/creatividad $k$ dentro del medio                  |
| ventas $y_b$         | contribución $C_{m,t,g}$                                  |
| exposición $w_{h,b}$ | señal a nivel campaña: impresiones, clicks, GRPs, etc.    |

Se define una exposición (o evidencia) por campaña:

* $w_{m,k,t,g}$: exposición de la campaña $k$ del medio $m$ en $(t,g)$
* opcionalmente, covariables $X_{m,k}$ (tipo de campaña, objetivo, formato, etc.)

En el caso base (sin covariables) se modela una productividad positiva por campaña dentro del medio:

* $\lambda_{m,k} > 0$ (tasa/productividad relativa de campaña $k$ dentro de medio $m$).

Modelo Poisson (para “unidades de contribución”):
$$
z_{m,k,t,g} \sim \operatorname{Poisson}(\lambda_{m,k} \cdot w_{m,k,t,g}),
\qquad
C_{m,t,g}=\sum_k z_{m,k,t,g}.
$$

Si $C$ es continua (euros), el caso Gamma aparece más adelante.

## EM explícito en MMM→MTA

### E-step: repartir $C_{m,t,g}$ dentro de cada $(m,t,g)$

Definiendo
$$
\mu_{m,k,t,g}^{(r)} = \lambda_{m,k}^{(r)} \cdot w_{m,k,t,g},
\qquad
p_{m,k,t,g}^{(r)}=
\frac{\mu_{m,k,t,g}^{(r)}}{\sum_{k'}\mu_{m,k',t,g}^{(r)}},
$$
se obtiene:
$$
\boxed{
\mathbb{E}[z_{m,k,t,g}\mid C_{m,t,g},\lambda^{(r)}]
=
C_{m,t,g} \cdot p_{m,k,t,g}^{(r)}
}.
$$

La interpretación es la misma que en HCP–Brick: dentro de cada (medio, tiempo, geo), una campaña recibe más contribución si tiene mayor exposición $w$ y/o mayor productividad $\lambda$.

### M-step: actualizar $\lambda_{m,k}$

Acumulando
$$
\widetilde{z}_{m,k}=\sum_{t,g}\mathbb{E}[z_{m,k,t,g}],
\qquad
\widetilde{w}_{m,k}=\sum_{t,g} w_{m,k,t,g},
$$
la actualización MLE tipo Poisson es:
$$
\boxed{
\lambda_{m,k}^{(r+1)} = \frac{\widetilde{z}_{m,k}}{\widetilde{w}_{m,k}}
}.
$$

Esto define un EM completo en el caso sin covariables.

## Extensión: covariables y regularización

Como en capítulos anteriores, se parametriza la productividad con covariables:
$$
\lambda_{m,k}=\exp(X_{m,k}\beta_m).
$$

El M-step se convierte en un **Poisson GLM con offset**:

* response: $\widetilde{z}_{m,k}$
* offset: $\log \widetilde{w}_{m,k}$
* regularización (ridge/lasso) para estabilidad.

## Caso euros (contribuciones continuas)

Si $C_{m,t,g}$ es continua (moneda), Gamma suele funcionar bien:
$$
z_{m,k,t,g} \sim \operatorname{Gamma}(k,\ \theta_{m,k} w_{m,k,t,g}),
\qquad
	heta_{m,k}=\exp(X\beta).
$$

En muchas parametrizaciones razonables, el reparto del E-step queda (muy similar):
$$
\mathbb{E}[z_{m,k,t,g}\mid C_{m,t,g}]
\approx
C_{m,t,g}\cdot
\frac{\theta_{m,k} w_{m,k,t,g}}{\sum_{k'}\theta_{m,k'} w_{m,k',t,g}},
$$
y el M-step se implementa como Gamma-GLM (log link) con regularización.

## Qué se aprende y cuáles son los límites

Este EM aprende **productividad relativa intra-medio** consistente con:

* la serie temporal (y geo) de contribución total del MMM
* el patrón de exposición de campañas (impresiones/GRPs/clicks, o la señal efectiva derivada de ellas).

No recupera “verdad causal por campaña” si:

* el MMM no está bien identificado por canal
* hay campañas altamente colineales dentro del medio
* falta señal de exposición $w$ o es muy ruidosa.

Como mecanismo de desagregación coherente del total del MMM, el enfoque es útil cuando se busca estabilidad, auditabilidad y conservación de masa.

## Granularidad horaria en MTA (extensión)

MMM suele operar en semanal/día, mientras que MTA a veces se requiere a hora/minuto. Tres rutas típicas:

1. Downscaling con modelo de intensidad
   Se estima un perfil intradía $q(h \mid k,g)$ con logs de delivery horario y se reparte:
   $$
   z_{m,k,t,g,h} = z_{m,k,t,g}\cdot q(h\mid k,g).
   $$
   Esta etapa puede ser determinista o implementarse con EM a dos niveles.

2. Estado-espacio / *smoothing* temporal
   Se trata $\lambda_{m,k,t}$ como un proceso (p. ej. *random walk*) y se hace inferencia (Kalman/VI). Es útil cuando las productividades varían con el tiempo a alta frecuencia.

3. Modelo unificado a alta frecuencia
   Requiere outcomes y exposición a esa frecuencia; es una opción más costosa y con mayor ruido.

## Adstock y saturación en el reparto (exposición efectiva)

### Naturaleza causal del reparto

Si el MMM es incremental, el total que se reparte por canal/medio y por $(t,g)$ puede conservar esa interpretación. El reparto dentro del canal (campañas/creatividades) no es automáticamente causal salvo que exista identificación causal intra-canal (experimentos, shocks exógenos, reglas de asignación, etc.).

### Incorporación de transformaciones MMM-consistentes

Para campañas/creatividades $k$ del canal $m$ se observa una señal cruda:

* $x_{m,k,t,g}$: impresiones / GRPs / TRPs.

Las transformaciones típicas del MMM se escriben como:

1. Adstock (carryover):
   $$
   a_{m,k,t,g} = \operatorname{Adstock}(x_{m,k,\cdot,g}; \theta_m)
   $$
   (p. ej. geométrico con decay $\theta_m$ o Weibull).

2. Saturación (rendimientos decrecientes):
   $$
   s_{m,k,t,g} = \operatorname{Sat}(a_{m,k,t,g}; \phi_m)
   $$
   (p. ej. Hill o logística).

Una forma MMM-consistente de definir la exposición del EM es tomar la exposición efectiva:
$$
w_{m,k,t,g} := s_{m,k,t,g}.
$$

Con esta elección, el E-step toma la forma:
$$
\hat z_{m,k,t,g}
=
C_{m,t,g}^{inc}\cdot
\frac{\lambda_{m,k} \cdot s_{m,k,t,g}}{\sum_{k'} \lambda_{m,k'} \cdot s_{m,k',t,g}}.
$$

Es posible extender el M-step para aprender también parámetros de transformación ($\theta_m,\phi_m$), pero el problema tiende a ser muy no convexo, con identificabilidad débil (especialmente intra-canal) y entrenamiento frágil. En práctica, un punto de partida estable es fijar $\theta_m,\phi_m$ (tomados del MMM) y aprender únicamente el reparto intra-canal.

Si el MMM está a nivel canal y no hay series por campaña, el enfoque sigue siendo *top-down*: se construye $s_{m,k,t,g}$ a partir de delivery por campaña (imps/GRPs) usando los mismos $\theta_m,\phi_m$ y se reparte $C_{m,t,g}^{inc}$ con la ecuación anterior.

## Ejercicio propuesto (con solución)

Implementar EM para un solo medio $m$ con:

* $C_t$ semanal
* campañas $k\in\{1,\dots,K\}$
* exposición $w_{k,t}$

y estimar $\lambda_k$ y $z_{k,t}$.

La solución corresponde a las ecuaciones de E-step/M-step anteriores; la extensión a covariables sustituye el M-step cerrado por un GLM con offset.

## Notebook de referencia

El repositorio incluye un notebook end-to-end del caso MMM→MTA (mock data y reparto EM) en:

[em_mmm_to_mta_adstock_saturation.ipynb](em_mmm_to_mta_adstock_saturation.ipynb)

Incluye:

* mock data con tiempo $\times$ geo
* transformaciones adstock geométrico y saturación Hill
* generación de contribución incremental por medio (como salida del MMM)
* EM cerrado (sin covariables) para estimar productividades intra-medio $\lambda_{m,k}$ y atribuciones $\hat z_{m,k,t,g}$
* checks: conservación de masa $\sum_k \hat z = C$ y evaluación frente a *ground truth*.

## Covariables: qué aparece en el notebook y catálogos útiles

### Covariables explícitas definidas en el notebook

En `campaign_df` se crea metadata categórica que queda preparada para el siguiente paso (no se usa todavía dentro del EM):

```python
campaign_rows.append({
    "medium": m,
    "campaign": f"{m}_C{k+1}",
    "creative_family": rng.choice(["A", "B", "C"]),
    "objective": rng.choice(["Awareness", "Consideration", "Conversion"]),
})
```

Estas columnas constituyen un ejemplo de covariables potenciales para activar una parametrización:
$$
\lambda_{m,k} = \exp(X_{m,k}\beta_m).
$$

### Tiempo y geo como estructura implícita

Sin entrar como regresores paramétricos, tiempo y geo afectan al reparto vía la exposición efectiva. En el notebook aparece, por ejemplo:

```python
time_season = 1.0 + sinusoides(...)
```

Además, adstock y saturación dependen del histórico, con lo que el tiempo entra como estructura dinámica dentro de $w_{m,k,t,g}$. A nivel geo, un `geo_effect` multiplicativo y variabilidad de delivery modulan esa misma señal efectiva.

### La “covariable clave”: exposición efectiva

La exposición usada en EM es:
$$
w_{m,k,t,g} = s_{m,k,t,g}
= \operatorname{Hill}(\operatorname{Adstock}(x_{m,k,t,g})),
$$
donde $x$ son impresiones/GRPs, adstock introduce memoria temporal y la saturación modela rendimientos decrecientes. En la práctica, gran parte de la señal explicativa reside en esta transformación.

### Componentes deliberadamente no activados

El notebook no activa aún:

* regresión Poisson/Gamma en el M-step
* $\lambda_{m,k} = \exp(X\beta)$
* regularización
* pooling entre campañas similares.

La intención es separar primero el EM cerrado “puro” y activar después covariables como extensión controlada.

## Sets de covariables recomendados (referencia)

### Covariables a nivel campaña / creatividad

Estas irían en $X_{m,k}$.

Creatividad / formato:

* tipo de formato (video, display, search text)
* duración (6s / 15s / 30s)
* tamaño
* orientación (vertical/horizontal)
* family / concepto creativo.

Objetivo:

* awareness / consideration / conversion
* upper vs lower funnel
* always-on vs tactical.

Audiencia / targeting:

* prospecting vs retargeting
* broad vs custom
* socio-demo bucket
* lookalike depth.

Uso típico:

```text
lambda_{m,k} = exp(
  β0
+ β1 * is_video
+ β2 * is_conversion
+ β3 * retargeting
+ β4 * creative_family_B
)
```

### Covariables de historial / madurez (no dependientes de $t$)

* antigüedad de la campaña
* número de flights pasados
* frecuencia histórica media
* porcentaje de tiempo activa.

Estas variables ayudan a regularizar campañas nuevas y a evitar que el EM sobre-asigne ruido.

### Covariables de interacción con exposición

Ejemplos:

* creatividades que saturan antes que otras
* distintos decays por formato.

Se puede modelar:
$$
\lambda_{m,k} = \exp(X_k \beta)
\quad\text{y/o}\quad
\gamma_{m,k} = \exp(Z_k \delta),
$$
y usar $\gamma$ para modular la saturación (extensión avanzada).

### Covariables a nivel medio (priors compartidos)

Para evitar sobreajuste:
$$
\beta_m \sim \mathcal N(\beta_{global}, \Sigma).
$$

Esto introduce pooling jerárquico y resulta útil cuando hay muchos medios con pocas campañas.

## Siguiente paso conceptual (cambio del M-step)

El paso siguiente cambia solo el M-step.

Antes:
$$
\lambda_{m,k} = \frac{\sum_{t,g} \hat z_{m,k,t,g}}{\sum_{t,g} w_{m,k,t,g}}.
$$

Después:
$$
\lambda_{m,k} = \exp(X_{m,k}\beta_m),
$$
y el M-step se implementa como Poisson o Gamma GLM con response $\widetilde{z}_{m,k}$, offset $\log \widetilde{w}_{m,k}$ y regularización (ridge/lasso).

## Nota sobre exposición ($w$ / $\omega$)

En este capítulo se usa $w$ como notación canónica de exposición (u oportunidad). En otros textos aparece el mismo concepto como $\omega$. Para la definición formal, nomenclatura técnica (exposure/offset/effective exposure) y una discusión operativa de interpretaciones (incluida la normalización), ver [93-ap-3-exposure.qmd](93-ap-3-exposure.qmd).

## Paralelismo formal HCP–Brick ↔ MMM–MTA

El modelo es isomórfico: se trata del mismo objeto estadístico con semántica distinta.

### Tabla formal de equivalencia

| Concepto estadístico        | HCP–Brick                                         | MMM → MTA                                                     |
| --------------------------- | ------------------------------------------------- | ------------------------------------------------------------- |
| Unidad agregada (observada) | Brick $b$                                         | Medio $m$, tiempo $t$, geo $g$                                |
| Unidad individual (latente) | HCP $h$                                           | Campaña / Creatividad $k$                                     |
| Observación agregada        | Ventas del brick $y_b$                            | Contribución incremental $C_{m,t,g}$                          |
| Variable latente            | $z_{h,b}$: ventas de $h$ en $b$                   | $z_{m,k,t,g}$: contribución de $k$                            |
| Restricción dura            | $\sum_h z_{h,b} = y_b$                            | $\sum_k z_{m,k,t,g} = C_{m,t,g}$                              |
| Productividad               | $\lambda_h$                                       | $\lambda_{m,k}$                                               |
| Exposición                  | $w_{h,b}$ (a veces $\omega_{b,h}$)                | $w_{m,k,t,g}$ (a veces $\omega_{m,k,t,g}$)                    |
| Exposición cruda            | pertenencia / visitas                             | impresiones / GRPs                                            |
| Exposición efectiva         | visitas ponderadas                                | Hill(Adstock(imps))                                           |
| Modelo latente              | $z \sim \operatorname{Poisson}(\lambda w)$       | $z \sim \operatorname{Poisson}(\lambda w)$ (o $\operatorname{Gamma}$) |
| E-step                      | reparto dentro del brick                          | reparto dentro de $(m,t,g)$                                   |
| M-step (simple)             | $\lambda_h = \frac{\sum_b \hat z}{\sum_b w}$     | $\lambda_{m,k} = \frac{\sum_{t,g} \hat z}{\sum_{t,g} w}$     |
| M-step (con features)       | $\lambda_h=\exp(X_h\beta)$                       | $\lambda_{m,k}=\exp(X_{m,k}\beta_m)$                          |
| Interpretación del output   | atribución por HCP                                | atribución por campaña/crea                                   |
| Naturaleza causal           | reparto atribucional                              | intra-canal atribucional (total potencialmente incremental)   |

### Misma ecuación central (cambiando nombres)

HCP–Brick:
$$
\hat z_{h,b}
=
y_b \cdot
\frac{\lambda_h \cdot \omega_{b,h}}{\sum_{h'} \lambda_{h'} \cdot \omega_{b,h'}}.
$$

MMM–MTA:
$$
\hat z_{m,k,t,g}
=
C_{m,t,g} \cdot
\frac{\lambda_{m,k} \cdot \omega_{m,k,t,g}}{\sum_{k'} \lambda_{m,k'} \cdot \omega_{m,k',t,g}}.
$$

### Interpretación semántica

| Símbolo   | Significado universal                   |
| --------- | --------------------------------------- |
| $z$       | “quién explica cuánto del total”        |
| $y$ / $C$ | total observado que debe explicarse     |
| $\lambda$ | eficiencia / productividad relativa     |
| $w$/$\omega$  | oportunidad / intensidad de exposición  |
| E-step    | reparto consistente                     |
| M-step    | aprendizaje de productividades          |

### Qué cambia entre los casos

En HCP–Brick, $\omega$ (o $w$) suele ser simple (0/1 o visitas) y el problema es esencialmente espacial. En MMM–MTA, $\omega$ (o $w$) se modela mediante transformaciones (adstock y saturación) y el problema es temporal con un componente *top-down* desde el total del MMM.

### Errores comunes evitables

* No es “otro modelo”: es el mismo EM con otra semántica.
* $\omega$ no debe sumar 1; solo importa relativamente dentro del agregado.
* Si el total es incremental, el reparto intra-canal no se vuelve incremental automáticamente.

## Cierre

La exposición $w$ (o $\omega$) es una elección de modelado. Para que el reparto sea defendible, debe ser no negativa, interpretable y coherente con el proceso real; a partir de esa señal, EM combina exposición y productividad para producir un reparto consistente con el total observado.

En el caso MMM→MTA con impresiones/GRPs, una elección MMM-consistente es definir la exposición como señal efectiva:
$$
w_{m,k,t,g} = s_{m,k,t,g} = \operatorname{Hill}(\operatorname{Adstock}(x_{m,k,t,g})).
$$

## Resumen

- El MMM entrega contribuciones observadas $C_{m,t}$ o $C_{m,t,g}$; el reparto introduce variables latentes $z_{m,k,t}$ o $z_{m,k,t,g}$ con restricción $\sum_k z=C$.
- El EM se formula con *productividades* $\lambda_{m,k}>0$ y una *exposición* $w_{m,k,t,g}\ge 0$; el E-step calcula shares y el M-step actualiza parámetros.
- Para respetar la lógica del MMM, la exposición se define de forma MMM-consistente como $w=\operatorname{Hill}(\operatorname{Adstock}(x))$, con $x$ igual a impresiones/GRPs.
- Si $C$ es continua (euros), se puede usar Gamma; el reparto del E-step conserva la misma forma de cocientes.
