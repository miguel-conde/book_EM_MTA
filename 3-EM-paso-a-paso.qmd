# EM paso a paso en este contexto

Nos centramos en el caso **unidades (Poisson)** porque ah√≠ EM queda **cerrado** y muy limpio. Luego te dejo al final el an√°logo para **euros (Gamma)**.

## 0Ô∏è‚É£ Recordatorio del modelo (del Cap√≠tulo 2)

Para cada brick $b$ y HCP $h \in \mathcal{H}_b$:

-   Latentes (no observados):
    $$
    z_{h,b} \sim \text{Poisson}(\lambda_h w_{h,b})
    $$

-   Observado:
    $$
    y_b = \sum_{h \in \mathcal{H}_b} z_{h,b}
    $$

-   Par√°metros:
    $\lambda_h > 0$ (productividad/tasa por exposici√≥n)

## 1Ô∏è‚É£ Idea clave: condicionando en el total

Propiedad fundamental:

Si $(z_1,\dots,z_K)$ son Poisson independientes con medias $(\mu_1,\dots,\mu_K)$, entonces condicionado en la suma $y=\sum_k z_k$:

$$
(z_1,\dots,z_K)\mid y \sim \text{Multinomial}\left(y;\, p_1,\dots,p_K\right)
$$
donde
$$
p_k = \frac{\mu_k}{\sum_j \mu_j}
$$

En nuestro caso, para un brick $b$:

-   $\mu_{h,b} = \lambda_h w_{h,b}$

-   $y = y_b$

## 2Ô∏è‚É£ E-step: contribuci√≥n esperada por HCP dentro del brick

Definimos el ‚Äúshare‚Äù esperado (responsabilidad) del HCP (h) en el brick (b):

$$
p_{h,b}^{(t)} = \frac{\lambda_h^{(t)} w_{h,b}}{\sum_{h' \in \mathcal{H}_b} \lambda_{h'}^{(t)} w_{h',b}}
$$

Entonces:

$$
\boxed{\mathbb{E}\left[z_{h,b} \mid y_b, \lambda^{(t)}\right] = y_b\, p_{h,b}^{(t)}}
$$

y adem√°s (√∫til para el M-step):

$$
\mathbb{E}\left[\log p(z_{h,b} \mid \lambda_h)\right]
\ \text{se eval√∫a usando}\
\mathbb{E}[z_{h,b}]
$$
porque en Poisson el log-likelihood depende de (z) linealmente salvo el (\\log(z!)) (que no depende de (\\lambda_h) en el M-step).

üîé **Interpretaci√≥n inmediata**

-   Dentro de un brick, EM reparte el total (y_b) proporcionalmente a ‚Äúcapacidad‚Äù actual:\
    $\lambda_h^{(t)} w_{h,b}$.

-   Si $w_{h,b}=1$, es proporcional solo a $\lambda_h^{(t)}$.

## 3Ô∏è‚É£ M-step: actualizar la productividad de cada HCP

Si los (z\_{h,b}) fueran observados, el MLE de (\\lambda_h) ser√≠a:

$$
\hat{\lambda}_h = \frac{\sum_b z_{h,b}}{\sum_b w_{h,b}}
$$

Como no lo son, EM sustituye (z\_{h,b}) por su esperanza del E-step:

$$
\boxed{\lambda_h^{(t+1)} =
\frac{\sum_{b: h \in \mathcal{H}_b} \mathbb{E}[z_{h,b}\mid y_b, \lambda^{(t)}]}{\sum_{b: h \in \mathcal{H}_b} w_{h,b}}}
$$

Sustituyendo expl√≠citamente:

$$
\boxed{\lambda_h^{(t+1)} =
\frac{\sum_{b: h \in \mathcal{H}_b} y_b \cdot
\frac{\lambda_h^{(t)} w_{h,b}}{\sum_{h' \in \mathcal{H}_b} \lambda_{h'}^{(t)} w_{h',b}}}{\sum_{b: h \in \mathcal{H}_b} w_{h,b}}}
$$

## 4Ô∏è‚É£ Interpretaci√≥n probabil√≠stica del ‚Äúshare‚Äù de ventas

Hay dos niveles de ‚Äúshare‚Äù, y es √∫til separarlos:

### A) Share **dentro del brick** (local)

$$
\boxed{p_{h,b}^{(t)} =
\frac{\lambda_h^{(t)} w_{h,b}}{\sum_{h' \in \mathcal{H}_b} \lambda_{h'}^{(t)} w_{h',b}}}
$$

Esto es literalmente:

-   la probabilidad de que una unidad del brick (b) ‚Äúvenga‚Äù del HCP (h),\
    bajo el modelo actual,

-   y la esperanza de unidades atribuibles es $y_b\,p_{h,b}^{(t)}$.

### B) Share **global** del HCP (agregando bricks)

Una vez tienes $\mathbb{E}[z_{h,b}]$, puedes construir:

$$
	\text{Ventas esperadas de } h = \sum_b \mathbb{E}[z_{h,b}]
$$

y el share global sobre el total:

$$
	\text{Share}_h = \frac{\sum_b \mathbb{E}[z_{h,b}]}{\sum_b y_b}
$$

## 5Ô∏è‚É£ Resumen del algoritmo EM (Poisson) en 4 l√≠neas

Inicializa (\\lambda_h\^{(0)}\>0). Repite hasta convergencia:

**E-step**:\
$$
p_{h,b}^{(t)} = \frac{\lambda_h^{(t)} w_{h,b}}{\sum_{h' \in \mathcal{H}_b} \lambda_{h'}^{(t)} w_{h',b}}
\quad;\quad
\hat z_{h,b}^{(t)} = y_b\,p_{h,b}^{(t)}
$$

**M-step**:\
$$
\lambda_h^{(t+1)} = \frac{\sum_b \hat z_{h,b}^{(t)}}{\sum_b w_{h,b}}
$$

üìå Esto ya es **EM totalmente expl√≠cito** para tu caso.

## 6Ô∏è‚É£ Nota r√°pida: an√°logo para euros (Gamma)

Si modelas euros con Gamma y eliges una parametrizaci√≥n aditiva (por ejemplo, misma forma (k) y media proporcional a (\\theta_h w\_{h,b})), aparece un resultado an√°logo:

-   El reparto en el E-step suele terminar siendo (bajo esas parametrizaciones) proporcional a la contribuci√≥n esperada:\
    $$
    \mathbb{E}[z_{h,b}\mid y_b] \approx y_b \cdot
    \frac{\theta_h w_{h,b}}{\sum_{h'} \theta_{h'} w_{h',b}}
    $$

-   El M-step actualiza (\\theta_h) parecido a ‚Äúventas esperadas / exposici√≥n‚Äù.

La diferencia es que, dependiendo de c√≥mo parametrices Gamma (shape/scale vs shape/rate) y si estimas (k), el M-step puede requerir:

-   o una actualizaci√≥n cerrada,

-   o un paso num√©rico (Newton) para (k).

(En el curso, cuando lleguemos a euros, lo dejaremos consistente y operativo.)

## ‚úÖ Checkpoint

¬øTe cuadra esta lectura?

-   E-step = ‚Äúreparto probabil√≠stico‚Äù por brick seg√∫n $\lambda_h w_{h,b}$

-   M-step = ‚Äúrecalibrar‚Äù $\lambda_h$ como ventas esperadas / exposici√≥n

Si todo OK, pasamos al **Cap√≠tulo 4** y lo hacemos **con un ejemplo num√©rico peque√±o a mano** (2 bricks, 4 HCPs) para que se vea c√≥mo convergen $\lambda$ y los shares.