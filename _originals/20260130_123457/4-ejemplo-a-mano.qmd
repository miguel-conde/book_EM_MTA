# Ejemplo num√©rico peque√±o (a mano)

Vamos a hacerlo **m√≠nimo pero completo**: 2 bricks, 4 HCPs, ventas agregadas por brick, y veremos 2‚Äì3 iteraciones de EM para que la mec√°nica quede grabada.

Trabajamos con **unidades** y el modelo **Poisson** del Cap√≠tulo 3, con pesos simples.

## 1Ô∏è‚É£ Setup del ejemplo

### Bricks y ventas observadas

-   Brick A: $y_A = 100$

-   Brick B: $y_B = 60$

### HCPs y pertenencia (overlap)

-   En Brick A est√°n: H1, H2, H3

-   En Brick B est√°n: H2, H3, H4

### Exposici√≥n (para simplificar)

Tomamos $w_{h,b}=1$ si el HCP pertenece al brick, $0$ si no.

## 2Ô∏è‚É£ Inicializaci√≥n (iteraci√≥n 0)

Inicializamos productividades (tasas) arbitrarias, todas positivas:

$$
\lambda^{(0)} = (\lambda_1,\lambda_2,\lambda_3,\lambda_4) = (1.0,\ 1.0,\ 1.0,\ 1.0)
$$

## 3Ô∏è‚É£ Iteraci√≥n 0 ‚Üí 1

### ‚úÖ E-step (reparto dentro de cada brick)

**Brick A (H1,H2,H3):** suma de tasas = (1+1+1=3)

Shares:

-   (p\_{1,A}=1/3)
-   $p_{1,A}=1/3$

-   $p_{2,A}=1/3$

-   $p_{3,A}=1/3$

Atribuciones esperadas:

-   (\\hat z\_{1,A}=100\\cdot 1/3=33.33)
-   $\hat z_{1,A}=100\cdot 1/3=33.33$

-   $\hat z_{2,A}=33.33$

-   $\hat z_{3,A}=33.33$

**Brick B (H2,H3,H4):** suma = (1+1+1=3)

Atribuciones esperadas:

-   (\\hat z\_{2,B}=60\\cdot 1/3=20)
-   $\hat z_{2,B}=60\cdot 1/3=20$

-   $\hat z_{3,B}=20$

-   $\hat z_{4,B}=20$

### ‚úÖ M-step (actualizaci√≥n de $\lambda$)

Usamos:

$$
\lambda_h^{(1)}=\frac{\sum_b \hat z_{h,b}}{\sum_b w_{h,b}}
$$

Exposiciones (n√∫mero de bricks en los que est√° cada HCP):

-   H1: 1 (solo A)

-   H2: 2 (A y B)

-   H3: 2 (A y B)

-   H4: 1 (solo B)

Entonces:

-   $\lambda_1^{(1)} = 33.33/1 = 33.33$

-   $\lambda_2^{(1)} = (33.33+20)/2 = 26.67$

-   $\lambda_3^{(1)} = (33.33+20)/2 = 26.67$

-   $\lambda_4^{(1)} = 20/1 = 20$

üìå Ya ves algo: **H1 sube mucho** porque tiene que explicar parte de un brick grande y no est√° ‚Äúpenalizado‚Äù por aparecer en varios bricks.

## 4Ô∏è‚É£ Iteraci√≥n 1 ‚Üí 2

### ‚úÖ E-step

**Brick A:** tasas (H1,H2,H3) = (33.33, 26.67, 26.67), suma = 86.67

Shares:

-   (p\_{1,A} = 33.33/86.67 \\approx 0.3846)
-   $p_{1,A} = 33.33/86.67 \approx 0.3846$

-   $p_{2,A} = 26.67/86.67 \approx 0.3077$

-   $p_{3,A} = 26.67/86.67 \approx 0.3077$

Atribuciones:

-   (\\hat z\_{1,A}=100\\cdot 0.3846=38.46)
-   $\hat z_{1,A}=100\cdot 0.3846=38.46$

-   $\hat z_{2,A}=30.77$

-   $\hat z_{3,A}=30.77$

**Brick B:** tasas (H2,H3,H4) = (26.67, 26.67, 20), suma = 73.34

Shares:

-   (p\_{2,B}=26.67/73.34\\approx 0.3636)
-   $p_{2,B}=26.67/73.34\approx 0.3636$

-   $p_{3,B}\approx 0.3636$

-   $p_{4,B}=20/73.34\approx 0.2727$

Atribuciones:

-   (\\hat z\_{2,B}=60\\cdot 0.3636=21.82)
-   $\hat z_{2,B}=60\cdot 0.3636=21.82$

-   $\hat z_{3,B}=21.82$

-   $\hat z_{4,B}=16.36$

### ‚úÖ M-step

-   (\\lambda_1\^{(2)} = 38.46/1 = 38.46)
-   $\lambda_1^{(2)} = 38.46/1 = 38.46$

-   $\lambda_2^{(2)} = (30.77+21.82)/2 = 26.30$

-   $\lambda_3^{(2)} = (30.77+21.82)/2 = 26.30$

-   $\lambda_4^{(2)} = 16.36/1 = 16.36$

Observa:

-   H1 sigue subiendo (absorbe m√°s del brick A)

-   H4 baja (ahora comparte con H2/H3 m√°s fuertes)

-   H2 y H3 se estabilizan

## 5Ô∏è‚É£ Iteraci√≥n 2 ‚Üí 3 (una m√°s para ver estabilidad)

### ‚úÖ E-step (r√°pido)

**Brick A:** $(38.46, 26.30, 26.30)$, suma = $91.06$
Shares:

-   H1: 0.4224 ‚Üí $\hat z_{1,A}=42.24$

-   H2: 0.2888 ‚Üí $\hat z_{2,A}=28.88$

-   H3: 0.2888 ‚Üí $\hat z_{3,A}=28.88$

**Brick B:** $(26.30, 26.30, 16.36)$, suma = $68.96$
Shares:

-   H2: 0.3814 ‚Üí $\hat z_{2,B}=22.88$

-   H3: 0.3814 ‚Üí $\hat z_{3,B}=22.88$

-   H4: 0.2372 ‚Üí $\hat z_{4,B}=14.23$

### ‚úÖ M-step

-   (\\lambda_1\^{(3)} = 42.24)
-   $\lambda_1^{(3)} = 42.24$

-   $\lambda_2^{(3)} = (28.88+22.88)/2 = 25.88$

-   $\lambda_3^{(3)} = (28.88+22.88)/2 = 25.88$

-   $\lambda_4^{(3)} = 14.23$

Ya est√° **casi convergido** (cambios peque√±os).

## 6Ô∏è‚É£ ¬øQu√© aprende EM ‚Äúrealmente‚Äù aqu√≠?

### ‚úÖ 1) Aprende productividades relativas coherentes con *todas* las ecuaciones de suma

No est√° ‚Äúprediciendo‚Äù (y_b) (eso ya est√° dado). Est√° encontrando (\\lambda_h) tal que:
No est√° ‚Äúprediciendo‚Äù $y_b$ (eso ya est√° dado). Est√° encontrando $\lambda_h$ tal que:

-   Brick A (100) se explique como suma esperada de H1,H2,H3
-   Brick A ($100$) se explique como suma esperada de H1,H2,H3

-   Brick B ($60$) se explique como suma esperada de H2,H3,H4

-   Y que el reparto sea estable y auto-consistente

### ‚úÖ 2) Los HCPs que aparecen en m√°s bricks quedan ‚Äúregularizados‚Äù por consistencia

H2 y H3 deben cuadrar **dos ecuaciones** (A y B), por eso se estabilizan.

### ‚úÖ 3) HCP ‚Äúexclusivo‚Äù de brick grande tiende a llevarse m√°s (si no hay m√°s estructura)

H1 solo est√° en A, as√≠ que el modelo puede subirlo sin que ‚Äúchoque‚Äù con otras restricciones.\
Esto es una pista de un *pitfall real*: **sin covariables o priors, la identificabilidad puede ser d√©bil**.

## 7Ô∏è‚É£ Lectura de negocio del resultado (share final aproximado)

Dentro de A (cerca de iteraci√≥n 3):

-   H1 ‚âà 42%

-   H2 ‚âà 29%

-   H3 ‚âà 29%

Dentro de B:

-   H2 ‚âà 38%

-   H3 ‚âà 38%

-   H4 ‚âà 24%

Eso es exactamente la attribution probabil√≠stica del E-step en convergencia.

## ‚úÖ Checkpoint

¬øTe ha quedado clara la din√°mica?

-   **E-step** reparte dentro de cada brick proporcional a (\\lambda)
-   **E-step** reparte dentro de cada brick proporcional a $\lambda$

-   **M-step** recalcula $\lambda$ como ‚Äúventas esperadas / exposici√≥n‚Äù

-   Los HCPs con overlap quedan m√°s ‚Äúanclados‚Äù; los exclusivos pueden absorber m√°s